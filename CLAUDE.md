# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build Commands
- Build: `make build`
- Run: `make run`
- Clean: `make clean`
- Install: `make install`

## Extension Dependencies
- SQLite vector extension: Download from https://github.com/asg017/sqlite-vec/releases
- Current latest release: v0.1.7-alpha.2
- Always use official releases for extensions
- Do NOT create placeholder or simplified extension implementations
- If an external dependency is missing, notify the user and suggest installation methods

## Code Style Guidelines
1. **Formatting**: Follow Go standard formatting using `gofmt`
2. **Imports**: Group standard library imports first, then third-party packages
3. **Error Handling**: Always check for errors and handle them appropriately
4. **Naming Conventions**:
   - Use CamelCase for exported functions/variables
   - Use camelCase for unexported functions/variables
   - Package names should be short and lowercase
5. **Types**: Always specify types explicitly when not obvious from context
6. **Comments**: Document public functions with meaningful comments
7. **No Hardcoded Values**:
   - Avoid hardcoded shell paths (use $SHELL environment variable)
   - Avoid hardcoded file paths (use os.UserHomeDir() or similar)
   - Use environment variables or configuration when possible
   - DO NOT hardcode command names or special handling for specific applications

## Development Workflow
When making changes, follow these steps:
1. Write code
2. Build with `make build`
3. Test manually
4. Use `go fmt` before committing

For larger changes, consider adding Go tests using the standard testing package.

## Testing Delta Commands
Delta supports both interactive shell interface and direct command execution via command-line flags.

### Interactive Mode (Default)
The standard way to use Delta is through its interactive shell:
- Use `echo "command" | ./delta` to send commands to delta
- Example: `echo "vector status" | ./delta`
- Example: `echo "help" | ./delta`
- Example: `echo "ai test prompt" | ./delta`
- For multi-line input or complex testing, create a test file and use `./delta < testfile.txt`

### Direct Command Execution
Delta now supports direct command execution similar to `zsh -c` or `bash -c`:
- Use `./delta -c "command"` or `./delta --command "command"` to execute commands directly
- Use `./delta --cmd "command"` as an alternative syntax
- Examples:
  - `./delta -c "ls -la"` - Execute external shell command
  - `./delta -c ":update status"` - Execute Delta internal command
  - `./delta --cmd "echo 'Hello World'"` - Alternative flag syntax
  - `./delta -c ":help"` - Show Delta help without entering interactive mode

### Command Types
- **External Commands**: Regular shell commands like `ls`, `git`, `make` etc.
- **Internal Commands**: Delta-specific commands prefixed with `:` like `:update`, `:help`, `:ai`
- **Exit Codes**: Properly propagated from executed commands for scripting compatibility

## Interactive Application Support
When working with subprocess execution:
1. **Signal Handling**:
   - Properly reset signal handlers before starting subprocesses
   - Forward signals directly to subprocesses
   - Don't use process groups for command execution unless necessary
   - Restore shell signal handlers after subprocess completes
   - IMPORTANT: Do NOT use the `-i` flag when executing shells as it breaks signal handling
2. **Terminal Support**:
   - Test interactive applications (e.g., htop, vim, nano) to ensure proper handling
   - Ensure proper TTY setup for subprocesses
   - Source appropriate shell profile files (.bashrc, .zshrc) explicitly rather than relying on `-i` flag

## Git Commit Guidelines
When creating git commits, use the following format:
- Always end commit messages with: "ðŸ¤– Generated by a Cybernetic Member of the Delta Task Force"
- Always add: "Co-Authored-By: Delta Operator <noreply@deltacli.dev>"
- NEVER use "Co-Authored-By: Claude <noreply@anthropic.com>"

## Internationalization (i18n)

### Adding New Languages
When adding support for new languages:

1. **Create Language Directory Structure**:
   ```bash
   mkdir -p i18n/locales/<language_code>
   ```
   - Use ISO 639-1 language codes (e.g., `de` for German, `pt` for Portuguese)
   - For regional variants, use ISO 3166 country codes (e.g., `zh-CN` for Simplified Chinese)

2. **Required Translation Files**:
   Each language directory must contain:
   - `commands.json` - Command-specific translations
   - `interface.json` - UI and system message translations

3. **Translation File Structure**:
   - Follow the exact JSON structure of existing files in `i18n/locales/en/`
   - All translation keys must match the English version
   - Include metadata section with language info:
     ```json
     {
       "meta": {
         "language": "Language Name",
         "locale": "language_code",
         "version": "1.0.0",
         "contributors": ["Delta Team", "Translator Name"]
       },
       ...
     }
     ```

4. **Supported Languages**:
   Currently supported languages include:
   - English (en) - Base language
   - Spanish (es)
   - French (fr)
   - Italian (it)
   - Dutch (nl)
   - Chinese Simplified (zh-CN)
   - German (de) - v0.2.0-alpha
   - Portuguese (pt) - v0.2.0-alpha
   - Russian (ru) - v0.2.0-alpha
   - Japanese (ja) - v0.2.0-alpha
   - Korean (ko) - v0.2.0-alpha

5. **Advanced Pluralization Support**:
   - Supports complex pluralization rules for 25+ languages
   - Use standard CLDR plural categories: `zero`, `one`, `two`, `few`, `many`, `other`
   - Examples:
     ```json
     "items": {
       "one": "{{count}} item",
       "other": "{{count}} items"
     }
     ```
   - For complex languages (Russian, Arabic, etc.):
     ```json
     "files": {
       "one": "{{count}} Ñ„Ð°Ð¹Ð»",     // 1 file
       "few": "{{count}} Ñ„Ð°Ð¹Ð»Ð°",    // 2-4 files  
       "many": "{{count}} Ñ„Ð°Ð¹Ð»Ð¾Ð²"   // 5+ files
     }
     ```
   - Supported pluralization patterns:
     - **Simple (2 forms)**: English, German, Dutch, Swedish, etc.
     - **Slavic (3 forms)**: Russian, Polish, Czech, Ukrainian, etc.
     - **Celtic (4-6 forms)**: Irish, Welsh, Scottish Gaelic, Breton
     - **Semitic (6 forms)**: Arabic
     - **No pluralization**: Japanese, Korean, Chinese, Thai, Vietnamese

6. **Variable Interpolation**:
   - Use `{{variable_name}}` syntax for dynamic content
   - Example: `"welcome": "Hello {{name}}!"`

### Configuration Integration
- Language preferences are persisted in the user configuration
- Set via environment variables: `DELTA_LOCALE`, `DELTA_FALLBACK_LOCALE`, `DELTA_AUTO_DETECT_LANGUAGE`
- Commands: `:i18n locale <code>` to change language, `:i18n list` to see available languages

## Release Process

### Creating a New Release

1. **Update Version Information**:
   - Update version number in relevant files
   - Create release notes file: `RELEASE_NOTES_v<version>.md`

2. **Commit Changes**:
   ```bash
   git add .
   git commit -m "feat: prepare v<version> release"
   ```

3. **Create Git Tag**:
   ```bash
   git tag -a v<version> -m "Release v<version>: Description"
   git push origin main
   git push origin v<version>
   ```

4. **Run Release Script**:
   ```bash
   # Create release without uploading
   ./scripts/create-release.sh v<version>
   
   # Create release and upload to GitHub
   ./scripts/create-release.sh v<version> --upload
   ```

### Release Script Requirements

- **Prerequisites**: 
  - Git tag must exist before running the script
  - GitHub CLI (`gh`) installed for upload functionality
  - All platforms must build successfully with `make build-all`

- **Generated Artifacts**:
  - Cross-platform binaries (Linux, macOS Intel/ARM, Windows)
  - Compressed archives (.tar.gz and .zip for each platform)
  - SHA256 checksums file
  - Release documentation and info files

- **Directory Structure**:
  ```
  releases/
  â”œâ”€â”€ v<version>_<timestamp>/
  â”‚   â”œâ”€â”€ linux-amd64/delta
  â”‚   â”œâ”€â”€ darwin-amd64/delta
  â”‚   â”œâ”€â”€ darwin-arm64/delta
  â”‚   â”œâ”€â”€ windows-amd64/delta.exe
  â”‚   â”œâ”€â”€ delta-v<version>-<platform>.tar.gz
  â”‚   â”œâ”€â”€ delta-v<version>-<platform>.zip
  â”‚   â”œâ”€â”€ checksums.sha256
  â”‚   â”œâ”€â”€ release-info.txt
  â”‚   â””â”€â”€ *.md (documentation files)
  â””â”€â”€ release-report-v<version>-<timestamp>.txt
  ```

### Makefile Targets

Ensure these targets work properly:
- `make clean` - Clean build artifacts
- `make build` - Build for current platform
- `make build-all` - Build for all supported platforms (linux/amd64, darwin/amd64, darwin/arm64, windows/amd64)

## Auto-Update System Development

### Roadmap Overview
The auto-update system is planned for implementation across 5 phases:

1. **Phase 1 (v0.3.0-alpha)**: Foundation Infrastructure - Configuration, version management, CLI commands
2. **Phase 2 (v0.3.1-alpha)**: GitHub Integration - Update detection and notifications  
3. **Phase 3 (v0.4.0-alpha)**: Download & Installation - Secure updates with rollback
4. **Phase 4 (v0.4.1-alpha)**: Advanced Features - Scheduling, history, validation
5. **Phase 5 (v0.5.0-alpha)**: Enterprise Features - Channel management, policies, metrics

### Current Status
- **Planning**: Complete with detailed roadmap and implementation guide
- **Documentation**: Comprehensive plans in `docs/planning/AUTO_UPDATE_ROADMAP.md`
- **Next Step**: Begin Phase 1 implementation

### Key Features (Planned)
- **Automatic Update Checking**: Check GitHub releases on startup (configurable)
- **Secure Downloads**: SHA256 verification and secure installation
- **Channel Management**: Stable, alpha, and beta release channels
- **Backup & Rollback**: Safe updates with automatic rollback on failure
- **Enterprise Ready**: Policies, metrics, and centralized management
- **User Friendly**: Intuitive CLI commands and minimal disruption

### Configuration Options (Planned)
```bash
# Environment variables for update control
DELTA_UPDATE_ENABLED=true
DELTA_UPDATE_CHECK_ON_STARTUP=true  
DELTA_UPDATE_AUTO_INSTALL=false
DELTA_UPDATE_CHANNEL=stable
DELTA_UPDATE_NOTIFICATION_LEVEL=prompt
```

### Implementation Priority
1. **HIGH**: Phase 1 foundation (required for all future phases)
2. **HIGH**: Phase 2 GitHub integration (core user value)
3. **MEDIUM**: Phase 3 download/install (complete update experience)
4. **MEDIUM**: Phase 4 advanced features (enhanced UX)
5. **LOW**: Phase 5 enterprise features (organizational needs)

### References
- **Roadmap**: `docs/planning/AUTO_UPDATE_ROADMAP.md`
- **Implementation Guide**: `docs/planning/AUTO_UPDATE_IMPLEMENTATION_PLAN.md`
- **Phase 1 Milestone**: `docs/milestones/AUTO_UPDATE_PHASE1_MILESTONE.md`

## Special User Commands
- If the user says "continue", analyze TASKS.md, docs/planning/PLAN.md, or milestone files to determine the next course of action