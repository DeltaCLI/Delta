# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build Commands
- Build: `make build`
- Run: `make run`
- Clean: `make clean`
- Install: `make install`

## Extension Dependencies
- SQLite vector extension: Download from https://github.com/asg017/sqlite-vec/releases
- Current latest release: v0.1.7-alpha.2
- Always use official releases for extensions
- Do NOT create placeholder or simplified extension implementations
- If an external dependency is missing, notify the user and suggest installation methods

## Code Style Guidelines
1. **Formatting**: Follow Go standard formatting using `gofmt`
2. **Imports**: Group standard library imports first, then third-party packages
3. **Error Handling**: Always check for errors and handle them appropriately
4. **Naming Conventions**:
   - Use CamelCase for exported functions/variables
   - Use camelCase for unexported functions/variables
   - Package names should be short and lowercase
5. **Types**: Always specify types explicitly when not obvious from context
6. **Comments**: Document public functions with meaningful comments
7. **No Hardcoded Values**:
   - Avoid hardcoded shell paths (use $SHELL environment variable)
   - Avoid hardcoded file paths (use os.UserHomeDir() or similar)
   - Use environment variables or configuration when possible
   - DO NOT hardcode command names or special handling for specific applications

## Development Workflow
When making changes, follow these steps:
1. Write code
2. Build with `make build`
3. Test manually
4. Use `go fmt` before committing
5. Update CHANGELOG.md under `## [Unreleased]` section

For larger changes, consider adding Go tests using the standard testing package.

### Maintaining the CHANGELOG
- Always add changes to the `## [Unreleased]` section at the top
- Follow [Keep a Changelog](https://keepachangelog.com/) format
- Categories: Added, Changed, Fixed, Deprecated, Removed, Security
- The release script will automatically move [Unreleased] to the version section
- Example entry:
  ```markdown
  ## [Unreleased]
  
  ### Added
  - Interactive safety prompts for dangerous commands
  - New `:validation stats` command
  
  ### Fixed
  - Direct command mode now includes training pipeline
  ```

## Testing Delta Commands
Delta supports both interactive shell interface and direct command execution via command-line flags.

### Direct Command Execution (Recommended for Testing)
Delta supports direct command execution similar to `zsh -c` or `bash -c`:
- Use `./delta -c "command"` or `./delta --command "command"` to execute commands directly
- Use `./delta --cmd "command"` as an alternative syntax
- Examples:
  - `./delta -c "ls -la"` - Execute external shell command
  - `./delta -c ":update status"` - Execute Delta internal command
  - `./delta --cmd ":help"` - Show Delta help without entering interactive mode
  - `./delta -c ":update validate --tests"` - List validation tests

### Interactive Mode (Default)
The standard way to use Delta is through its interactive shell:
- Run `./delta` to enter interactive mode
- For testing with input streams: `echo "command" | ./delta` (legacy method)
- For multi-line input or complex testing, create a test file and use `./delta < testfile.txt`

### Command Types
- **External Commands**: Regular shell commands like `ls`, `git`, `make` etc.
- **Internal Commands**: Delta-specific commands prefixed with `:` like `:update`, `:help`, `:ai`
- **Exit Codes**: Properly propagated from executed commands for scripting compatibility

## Interactive Application Support
When working with subprocess execution:
1. **Signal Handling**:
   - Properly reset signal handlers before starting subprocesses
   - Forward signals directly to subprocesses
   - Don't use process groups for command execution unless necessary
   - Restore shell signal handlers after subprocess completes
   - IMPORTANT: Do NOT use the `-i` flag when executing shells as it breaks signal handling
2. **Terminal Support**:
   - Test interactive applications (e.g., htop, vim, nano) to ensure proper handling
   - Ensure proper TTY setup for subprocesses
   - Source appropriate shell profile files (.bashrc, .zshrc) explicitly rather than relying on `-i` flag

## Git Commit Guidelines
When creating git commits, use the following format:
- Always end commit messages with: "ðŸ¤– Generated by a Cybernetic Member of the Delta Task Force"
- Always add: "Co-Authored-By: Delta Operator <noreply@deltacli.dev>"
- NEVER use "Co-Authored-By: Claude <noreply@anthropic.com>"

## Internationalization (i18n)

### Adding New Languages
When adding support for new languages:

1. **Create Language Directory Structure**:
   ```bash
   mkdir -p i18n/locales/<language_code>
   ```
   - Use ISO 639-1 language codes (e.g., `de` for German, `pt` for Portuguese)
   - For regional variants, use ISO 3166 country codes (e.g., `zh-CN` for Simplified Chinese)

2. **Required Translation Files**:
   Each language directory must contain:
   - `commands.json` - Command-specific translations
   - `interface.json` - UI and system message translations

3. **Translation File Structure**:
   - Follow the exact JSON structure of existing files in `i18n/locales/en/`
   - All translation keys must match the English version
   - Include metadata section with language info:
     ```json
     {
       "meta": {
         "language": "Language Name",
         "locale": "language_code",
         "version": "1.0.0",
         "contributors": ["Delta Team", "Translator Name"]
       },
       ...
     }
     ```

4. **Supported Languages**:
   Currently supported languages include:
   - English (en) - Base language
   - Spanish (es)
   - French (fr)
   - Italian (it)
   - Dutch (nl)
   - Chinese Simplified (zh-CN)
   - German (de) - v0.2.0-alpha
   - Portuguese (pt) - v0.2.0-alpha
   - Russian (ru) - v0.2.0-alpha
   - Japanese (ja) - v0.2.0-alpha
   - Korean (ko) - v0.2.0-alpha

5. **Advanced Pluralization Support**:
   - Supports complex pluralization rules for 25+ languages
   - Use standard CLDR plural categories: `zero`, `one`, `two`, `few`, `many`, `other`
   - Examples:
     ```json
     "items": {
       "one": "{{count}} item",
       "other": "{{count}} items"
     }
     ```
   - For complex languages (Russian, Arabic, etc.):
     ```json
     "files": {
       "one": "{{count}} Ñ„Ð°Ð¹Ð»",     // 1 file
       "few": "{{count}} Ñ„Ð°Ð¹Ð»Ð°",    // 2-4 files  
       "many": "{{count}} Ñ„Ð°Ð¹Ð»Ð¾Ð²"   // 5+ files
     }
     ```
   - Supported pluralization patterns:
     - **Simple (2 forms)**: English, German, Dutch, Swedish, etc.
     - **Slavic (3 forms)**: Russian, Polish, Czech, Ukrainian, etc.
     - **Celtic (4-6 forms)**: Irish, Welsh, Scottish Gaelic, Breton
     - **Semitic (6 forms)**: Arabic
     - **No pluralization**: Japanese, Korean, Chinese, Thai, Vietnamese

6. **Variable Interpolation**:
   - Use `{{variable_name}}` syntax for dynamic content
   - Example: `"welcome": "Hello {{name}}!"`

### Configuration Integration
- Language preferences are persisted in the user configuration
- Set via environment variables: `DELTA_LOCALE`, `DELTA_FALLBACK_LOCALE`, `DELTA_AUTO_DETECT_LANGUAGE`
- Commands: `:i18n locale <code>` to change language, `:i18n list` to see available languages

### i18n System Improvements (v0.4.2-alpha)
- **Automatic Installation**: i18n files now auto-install to `~/.config/delta/i18n/locales`
- **Built-in English**: Essential English translations built-in as fallback
- **Robust Path Detection**: Searches multiple locations for i18n files
- **User Notice**: Clear startup notice if translations are missing
- **Install Command**: `:i18n install` to manually install/update language files
- **Conditional Help**: Install command only shows when files are missing

## Release Process

### Creating a New Release

1. **Update Documentation**:
   - Update CHANGELOG.md with changes under `## [Unreleased]` section
   - Create release notes file: `RELEASE_NOTES_v<version>.md`
   - Ensure CHANGELOG.md has an `[Unreleased]` section (required)

2. **Commit Changes**:
   ```bash
   git add .
   git commit -m "feat: prepare v<version> release"
   ```

3. **Create Git Tag**:
   ```bash
   git tag -a v<version> -m "Release v<version>: Description"
   git push origin main
   git push origin v<version>
   ```

4. **Run Release Script**:
   ```bash
   # Create release without uploading
   ./scripts/create-release.sh v<version>
   
   # Create release and upload to GitHub
   ./scripts/create-release.sh v<version> --upload
   ```
   
   The script will automatically:
   - Update CHANGELOG.md (move [Unreleased] to version section)
   - Update ROADMAP.md with new version
   - Create binaries for all platforms
   - Generate checksums
   - Create GitHub release (if --upload is used)

### Release Script Requirements

- **Prerequisites**: 
  - Git tag must exist before running the script
  - GitHub CLI (`gh`) installed for upload functionality
  - All platforms must build successfully with `make build-all`

- **Generated Artifacts**:
  - Cross-platform binaries (Linux, macOS Intel/ARM, Windows)
  - Compressed archives (.tar.gz and .zip for each platform)
  - SHA256 checksums file
  - Release documentation and info files

- **Directory Structure**:
  ```
  releases/
  â”œâ”€â”€ v<version>_<timestamp>/
  â”‚   â”œâ”€â”€ linux-amd64/delta
  â”‚   â”œâ”€â”€ darwin-amd64/delta
  â”‚   â”œâ”€â”€ darwin-arm64/delta
  â”‚   â”œâ”€â”€ windows-amd64/delta.exe
  â”‚   â”œâ”€â”€ delta-v<version>-<platform>.tar.gz
  â”‚   â”œâ”€â”€ delta-v<version>-<platform>.zip
  â”‚   â”œâ”€â”€ checksums.sha256
  â”‚   â”œâ”€â”€ release-info.txt
  â”‚   â””â”€â”€ *.md (documentation files)
  â””â”€â”€ release-report-v<version>-<timestamp>.txt
  ```

### Makefile Targets

Ensure these targets work properly:
- `make clean` - Clean build artifacts
- `make build` - Build for current platform
- `make build-all` - Build for all supported platforms (linux/amd64, darwin/amd64, darwin/arm64, windows/amd64)

## Auto-Update System Development

### Roadmap Overview
The auto-update system is planned for implementation across 5 phases:

1. **Phase 1 (v0.3.0-alpha)**: Foundation Infrastructure - Configuration, version management, CLI commands
2. **Phase 2 (v0.3.1-alpha)**: GitHub Integration - Update detection and notifications  
3. **Phase 3 (v0.4.0-alpha)**: Download & Installation - Secure updates with rollback
4. **Phase 4 (v0.4.1-alpha)**: Advanced Features - Scheduling, history, validation
5. **Phase 5 (v0.5.0-alpha)**: Enterprise Features - Channel management, policies, metrics

### Current Status (v0.4.2-alpha)
- **Phase 1-4**: COMPLETED âœ“
- **Phase 1**: Foundation Infrastructure - COMPLETED in v0.3.0-alpha
- **Phase 2**: GitHub Integration - COMPLETED in v0.3.1-alpha
- **Phase 3**: Download & Installation - COMPLETED in v0.4.0-alpha
- **Phase 4**: Advanced Features - COMPLETED in v0.4.2-alpha
- **Next Step**: Phase 5 Enterprise Features (v0.5.0-alpha)

### Key Features (Implemented)
- **Automatic Update Checking**: Check GitHub releases on startup âœ“
- **Secure Downloads**: SHA256 verification and secure installation âœ“
- **Backup & Rollback**: Safe updates with automatic rollback on failure âœ“
- **Interactive Updates**: User-friendly prompts with skip/postpone options âœ“
- **Update Scheduling**: Cron-like scheduling for deferred updates âœ“
- **Update History**: Comprehensive tracking with metrics and audit trails âœ“
- **Post-Update Validation**: Health checks with automatic rollback âœ“
- **Channel Support**: Alpha/beta/stable channel management âœ“

### Enterprise Features (Phase 5 - Planned)
- **Advanced Channel Management**: Channel policies and access control
- **Enterprise Policies**: Centralized update management
- **Metrics & Reporting**: Analytics and performance tracking
- **Silent Updates**: Enterprise deployment options

### Configuration Options (Planned)
```bash
# Environment variables for update control
DELTA_UPDATE_ENABLED=true
DELTA_UPDATE_CHECK_ON_STARTUP=true  
DELTA_UPDATE_AUTO_INSTALL=false
DELTA_UPDATE_CHANNEL=stable
DELTA_UPDATE_NOTIFICATION_LEVEL=prompt
```

### Implementation Priority
1. **HIGH**: Phase 1 foundation (required for all future phases)
2. **HIGH**: Phase 2 GitHub integration (core user value)
3. **MEDIUM**: Phase 3 download/install (complete update experience)
4. **MEDIUM**: Phase 4 advanced features (enhanced UX)
5. **LOW**: Phase 5 enterprise features (organizational needs)

### References
- **Roadmap**: `docs/planning/AUTO_UPDATE_ROADMAP.md`
- **Implementation Guide**: `docs/planning/AUTO_UPDATE_IMPLEMENTATION_PLAN.md`
- **Phase 1 Milestone**: `docs/milestones/AUTO_UPDATE_PHASE1_MILESTONE.md`

## AI System Improvements (v0.4.2-alpha)

### Configuration Persistence
- AI enabled/disabled state now persists between sessions
- Configuration saved to `~/.config/delta/system_config.json`
- Settings loaded automatically on startup

### Command Aliases
- Added `:ai enable` as alias for `:ai on`
- Added `:ai disable` as alias for `:ai off`
- Help text updated to show aliases clearly

### Known Issues
- AI predictions require Ollama to be running with the configured model
- If Ollama is not available, AI features will be disabled but settings persist

## Recent Architecture Changes

### Update System (Phase 4 Complete)
- `update_history.go` - Comprehensive update tracking with system info
- `update_scheduler.go` - Cron-like scheduling for deferred updates
- `update_ui.go` - Interactive prompts with user choices
- `update_validation.go` - Post-update health checks and rollback

### Configuration Management
- Centralized configuration in `~/.config/delta/`
- All subsystems use ConfigManager for persistence
- Automatic config migration between versions

### Command Validation System (v0.4.5-alpha)
Command validation with interactive safety features has been implemented:

#### Core Components
- `validation/engine.go` - Main validation engine with multi-shell support
- `validation/safety_rules.go` - 17 built-in safety rules with risk levels
- `validation/risk_assessment.go` - Context-aware risk analysis
- `validation/permission_check.go` - Permission requirement detection
- `validation/interactive_safety.go` - Interactive safety prompts with education

#### Interactive Safety Features
- Smart confirmation prompts for risky operations
- Educational explanations for dangerous commands
- Safer alternative suggestions
- Command safety history tracking
- Risk levels: Low, Medium, High, Critical
- Auto-deny option for critical commands
- Trusted path detection (bypass prompts in safe directories)

#### Configuration
Configure validation with `:validation config set <key> <value>`:
- `enabled` - Enable/disable validation (default: true)
- `interactive_safety` - Enable interactive prompts (default: true)
- `educational_info` - Show educational content (default: true)
- `auto_deny_critical` - Auto-deny critical commands (default: true)
- `bypass_trusted_paths` - Skip prompts in trusted directories (default: true)

#### Usage
- Commands are automatically validated before execution
- `:validate <command>` - Manually check command syntax
- `:validation safety <command>` - Analyze command safety
- `:validation stats` - View safety decision statistics
- `:validation history` - View recent safety decisions
- `:validation config` - Manage configuration

## Special User Commands
- If the user says "continue", analyze TASKS.md, docs/planning/PLAN.md, or milestone files to determine the next course of action